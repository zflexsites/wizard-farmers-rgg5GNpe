import{r as L}from"./app-DZhGwkpm.js";function V(){console.log("[Preview] Initialisation du mode Ã©diteur temps rÃ©el (FOCUS V2 - LIVE ARCHITECTURE)"),N();const b=new Map;function A(t,e){b.set(t,e),console.log(`[Preview] Update buffÃ©risÃ©e pour ${t} (Ã©lÃ©ment manquant)`)}function z(){if(b.size===0)return;console.log(`[Preview] Tentative de rejouer le buffer (${b.size} messages)...`);const t=Array.from(b.values());b.clear(),t.forEach(e=>{E({data:e})})}H(),_();const S={"palette.primary":"--primary-color","palette.secondary":"--secondary-color","palette.background":"--bg-color","palette.text":"--text-color","palette.accent":"--accent-color","palette.cardBackground":"--card-bg-color","palette.textMuted":"--text-muted-color","palette.cardBorder":"--card-border-color","palette.inputBackground":"--input-bg-color","palette.chatResponseBackground":"--chat-response-bg-color",primary:"--primary-color",secondary:"--secondary-color",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardBackground:"--card-bg-color","primary-color":"--primary-color","bg-color":"--bg-color","card-bg-color":"--card-bg-color"};function h(t){if(!t)return null;if(typeof t=="string"&&t.startsWith("--"))return t;const e=String(t).trim(),o={"layout.borderRadius":"--border-radius","typography.headingFont":"--heading-font","typography.bodyFont":"--body-font"};if(o[e])return o[e];if(S[e])return S[e];if(e.startsWith("palette.")||e.startsWith("layout.")||e.startsWith("typography.")){const n=e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"").replace(/_/g,"").toLowerCase(),i={primary:"--primary-color",primary600:"--primary-600",primary700:"--primary-700",secondary:"--secondary-color",secondary600:"--secondary-600",background:"--bg-color",text:"--text-color",accent:"--accent-color",cardbackground:"--card-bg-color",textmuted:"--text-muted-color",cardborder:"--card-border-color",inputbackground:"--input-bg-color",chatresponsebackground:"--chat-response-bg-color",borderradius:"--border-radius",headingfont:"--heading-font",bodyfont:"--body-font"};return i[n]?i[n]:`--${e.replace(/^(palette|layout|typography)[\._-]?/i,"").replace(/\./g,"-").replace(/_([a-z0-9])/gi,(u,a)=>`-${a.toLowerCase()}`).replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`}return null}function I(t={}){if(!t||typeof t!="object")return;const e=document.documentElement;Object.keys(t).forEach(o=>{const n=t[o];if(typeof n!="string"&&typeof n!="number")return;const i=o.startsWith("--")?o:h(o)||`--${o}`;e.style.setProperty(i,String(n))}),window.requestAnimationFrame(()=>{document.body.offsetHeight})}function q(t){const{sections:e}=t,o=document.querySelector('main[data-zflex-page-type="home"]');if(!o)return;console.log("[Preview] Syncing layout...",e);const n=Array.from(o.children).filter(u=>u.hasAttribute("data-zflex-section")),i=e.map(u=>u.type);let d=[];n.forEach(u=>{const a=u.getAttribute("data-zflex-section");a&&!i.includes(a)&&(console.log(`[Preview] Removing section ${a}`),u.remove())}),e.forEach(u=>{const a=u.type,s=a.replace(/[A-Z]/g,l=>`_${l.toLowerCase()}`),r=o.querySelector(`[data-zflex-section="${a}"]`)||o.querySelector(`[data-zflex-section="${s}"]`);r?(o.appendChild(r),r.getAttribute("data-zflex-section")!==a&&r.setAttribute("data-zflex-section",a)):(console.log(`[Preview] Missing section ${a} (checked ${s} too)`),d.push(a))}),d.length>0&&(console.warn(`[Preview] ${d.length} sections manquant(s) dans le DOM :`,d),console.info("[Preview] L'injection de template devrait suivre. Pas de reload automatique (User choice)."))}function k(t){const{type:e,html:o}=t,n=document.querySelector('main[data-zflex-page-type="home"]');if(!n){console.error("[Preview] Injection annulÃ©e : Ã‰lÃ©ment <main> introuvable.");return}console.log(`%c [Preview] Injection du partiel pour : ${e} `,"background: #4f46e5; color: white; font-weight: bold; padding: 2px 4px; border-radius: 2px;");const i=document.createElement("div");i.innerHTML=o.trim();const d=Array.from(i.childNodes);let u=null;for(const a of d){if(a.nodeType!==Node.ELEMENT_NODE)continue;const s=a,r=s.tagName.toUpperCase();if(r==="STYLE")document.head.appendChild(s);else if(r==="TEMPLATE"){const l=s.getAttribute("data-zflex-variant"),c=s.getAttribute("data-zflex-template"),p=l||c;if(p){const g=document.querySelector(`template[data-zflex-variant="${p}"], template[data-zflex-template="${p}"]`);g&&g.remove()}document.body.appendChild(s)}else if(r==="SCRIPT"){const l=document.createElement("script");Array.from(s.attributes).forEach(c=>l.setAttribute(c.name,c.value)),l.textContent=s.textContent,document.body.appendChild(l)}else console.log(`[Preview] -> Potential content node found: ${r}`),u=s}if(u)try{const a=u;a.setAttribute("data-zflex-section",e),t.data&&(console.log(`[Preview] Hydratation immÃ©diate pour ${e} avec :`,t.data),v(a,t.data,e),a.querySelectorAll("[data-zflex-repeater]").forEach(l=>{const c=l.getAttribute("data-zflex-repeater");if(!c)return;const p=c.split("."),g=p[p.length-1],f=t.data[g];Array.isArray(f)&&x(l,c,f)}));const s=n.querySelector(`[data-zflex-section="${e}"]`);s?(console.log(`[Preview] Replacing existing section: ${e}`),s.replaceWith(a)):(console.log(`[Preview] Appending new section: ${e}`),n.appendChild(a)),console.log(`[Preview] Section ${e} injectÃ©e avec succÃ¨s (+ styles/templates).`),a.style.animation="pulse-glow 1s ease-in-out",typeof L=="function"&&L(a),z()}catch(a){console.error(`[Preview] Erreur fatale lors de l'injection de ${e}:`,a),z()}}function W(t){if(!t)return;const e=t.computed||{},o=t.palette||{},n={};Object.keys(o).forEach(i=>{const d=h(i)||h(`palette.${i}`)||`--${i}`;d&&(n[d]=o[i])}),Object.keys(e).forEach(i=>{const d=h(i)||`--${i.replace(/[A-Z]/g,u=>"-"+u.toLowerCase())}`;d&&(n[d]=e[i])}),I(n),console.log("[Preview] Applied computed palette vars:",n)}function T(t){if(t==null)return"";let e=String(t).trim();return/^[0-9A-Fa-f]{6}$/.test(e)&&(e="#"+e),e}function P(t){if(!t)return;let{property:e,value:o}=t;const n=h(e)||e,i=T(o);n&&(document.documentElement.style.setProperty(n,i),(n.includes("color")||n.includes("bg")||n.includes("background"))&&(document.body.style.transition="background-color 0.22s ease, color 0.22s ease, border-color 0.22s ease",setTimeout(()=>{document.body.style.transition=""},300)),console.log(`[Preview] Mise Ã  jour style (incoming: ${String(e)}) -> canonical: ${n}: ${i}`))}function M(t,e){if(!t)return;const{id:o,value:n}=t,i=h(o);if(i&&(i.startsWith("--")||o.startsWith("palette.")||o.startsWith("layout.")||o.startsWith("typography."))&&(P({property:o,value:n}),o.includes(".")&&(o.startsWith("palette")||o.startsWith("layout")||o.startsWith("typography"))))return;if(o==="howItWorks.showIcons"){const a=String(n)==="true",s=document.querySelector('[data-zflex-section="howItWorks"]');if(s){const r=s.querySelectorAll(".step-num"),l=s.querySelectorAll(".step-icon");r.forEach(c=>c.style.display=a?"none":""),l.forEach(c=>c.style.display=a?"":"none")}return}const d=document.querySelectorAll(`[data-zflex-show="${o}"]`);if(d.length>0){const a=String(n)==="true";d.forEach(s=>{s.style.setProperty("display",a?"":"none","important")}),a&&w(d[0])}let u=Array.from(document.querySelectorAll(`[data-zflex-id="${o}"]`)).filter(a=>!a.closest("template"));if(u.length===0&&o.includes(".")){const a=o.split(".").pop();u=Array.from(document.querySelectorAll(`[data-zflex-bind="${a}"]`)).filter(s=>{if(s.closest("template"))return!1;const r=o.split(".")[0];return!!(s.closest(`[data-zflex-section="${r}"]`)||s.closest(`[data-zflex-variant-container="${r}"]`))})}if(u.length===0){e?A(o,e):console.warn(`[Preview] Aucun Ã©lÃ©ment trouvÃ© pour : ${o}`);return}u.forEach(a=>{const s=a,r=s.tagName.toUpperCase();if(r==="IMG")console.log(`[Preview] Updating IMG src for ${o}:`,n),s.src=n,s.alt||(s.alt="Image");else if(r==="I"||s.classList.contains("fa")||o.toLowerCase().includes("icon")){let p=String(n).trim();if(!p)return;!p.startsWith("fa-")&&!p.includes(" ")&&(p=`fa-${p}`),/fa[srbl]/.test(p)||(p=`fas ${p}`);const g=Array.from(s.classList).filter(f=>!f.startsWith("fa-")&&!/fa[srbl]/.test(f)&&f!=="fa");s.className=`${g.join(" ")} ${p}`}const l=typeof n=="string"&&(n.startsWith("http")||n.startsWith("data:image")||n.startsWith("/"));if(o.toLowerCase().includes("image")||o.includes("bg")||o.includes("cover")||l&&r!=="IMG"&&r!=="I"){console.log(`[Preview] Updating BG for ${o}:`,n);const p=s.style.backgroundImage;if(p&&p.includes("gradient")){const g=p.replace(/url\(['"]?.*?['"]?\)/,`url('${n}')`);s.style.backgroundImage=g}else s.style.backgroundImage=`url('${n}')`}else/<[a-z][\s\S]*>/i.test(String(n))?s.innerHTML=String(n):s.textContent=String(n);r!=="I"&&w(s)})}function w(t){t&&(t.classList.remove("zflex-highlight-pulse"),t.offsetWidth,t.classList.add("zflex-highlight-pulse"),t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}))}function N(){if(document.getElementById("zflex-preview-styles"))return;const t=document.createElement("style");t.id="zflex-preview-styles",t.textContent=`
    .zflex-highlight-pulse {
      position: relative;
      animation: zflexHighlightPulse 1.2s ease-out;
      z-index: 100 !important;
    }
    @keyframes zflexHighlightPulse {
      0% { outline: 0px solid rgba(0, 229, 255, 0); outline-offset: 0px; }
      20% { outline: 4px solid rgba(0, 229, 255, 0.8); outline-offset: 2px; }
      100% { outline: 0px solid rgba(0, 229, 255, 0); outline-offset: 10px; }
    }
  `,document.head.appendChild(t)}function R(t){const{id:e}=t;let o=document.querySelector(`[data-zflex-section="${e.toLowerCase()}"]`)||document.querySelector(`[data-zflex-id="${e}"]`)||document.getElementById(e);o?w(o):console.log(`[Preview] Highlight: Element ${e} not found.`)}function E(t){if(!t?.data)return;const e=t.data;if(e.source==="zflex-admin")switch(console.log("[Preview] Message reÃ§u de l'Ã©diteur:",e),e.action){case"updateElement":M(e.payload,e);break;case"updateStyle":P(e.payload);break;case"updatePalette":W(e.payload);break;case"updateRepeater":B(e.payload,e);break;case"updateVariant":U(e.payload);break;case"updateLayout":q(e.payload);break;case"highlight":R(e.payload);break;case"injectTemplate":k(e.payload);break;default:console.warn("[Preview] Action non reconnue:",e.action)}}window.addEventListener("message",E);function U(t){const{id:e,variant:o,data:n}=t,i=document.querySelector(`[data-zflex-variant-container="${e}"]`),d=document.querySelector(`template[data-zflex-variant="${e}.${o}"]`);if(!i||!d){console.warn(`[Preview] Impossible de changer le variant : ${e} -> ${o} (Template/Container missing)`);return}console.log(`[Preview] Swap variant ${e} vers ${o}`);const a=d.content.cloneNode(!0).firstElementChild;a&&(v(a,n,e),a.querySelectorAll("[data-zflex-repeater]").forEach(r=>{const l=r.getAttribute("data-zflex-repeater");if(!l)return;const c=l.split("."),p=c[c.length-1],g=n[p];Array.isArray(g)&&x(r,l,g)}),i.style.opacity="0",setTimeout(()=>{i.innerHTML="",i.appendChild(a),i.style.opacity="1"},150))}function x(t,e,o){const n=document.querySelector(`template[data-zflex-template="${e}"]`);n&&(t.innerHTML="",o.forEach((i,d)=>{const a=n.content.cloneNode(!0).firstElementChild;a&&(j(a,e,d),v(a,i,`${e}[${d}]`),t.appendChild(a))}))}function j(t,e,o){if(t.querySelectorAll("[data-zflex-bind]").forEach(d=>{const u=d.getAttribute("data-zflex-bind");d.setAttribute("data-zflex-id",`${e}[${o}].${u}`)}),t.hasAttribute("data-zflex-bind")){const d=t.getAttribute("data-zflex-bind");t.setAttribute("data-zflex-id",`${e}[${o}].${d}`)}t.querySelectorAll("[data-zflex-show]").forEach(d=>{const u=d.getAttribute("data-zflex-show");u&&!u.startsWith(e)&&d.setAttribute("data-zflex-show",`${e}[${o}].${u}`)})}function v(t,e,o=""){const n=Array.from(t.querySelectorAll("[data-zflex-bind]"));t.hasAttribute("data-zflex-bind")&&n.push(t);const i=(r,l,c,p)=>{if(o&&!r.hasAttribute("data-zflex-id")&&r.setAttribute("data-zflex-id",`${o}.${l}`),c==null&&!(l==="icon"||l==="image"))return;const g=r.tagName.toUpperCase();if(r.textContent==="#"&&p!==void 0){r.textContent=String(p+1);return}if(g==="IMG")r.src=String(c||"");else if(l==="icon"||r.tagName==="I"||r.classList.contains("fa")){let f=String(c||"").trim();if(f){!f.startsWith("fa-")&&!f.includes(" ")&&(f=`fa-${f}`),!f.includes("fas")&&!f.includes("fab")&&!f.includes("far")&&!f.includes("fal")&&(f=`fas ${f}`);const m=Array.from(r.classList).filter(y=>!y.startsWith("fa")&&y!=="fas"&&y!=="fab"&&y!=="far"&&y!=="fal");r.className=`${m.join(" ")} ${f}`}}else if(l.toLowerCase().includes("image")||l.includes("bg")||l.includes("cover")){if(g!=="IMG"){const f=r.style.backgroundImage;if(f&&f.includes("gradient")){const m=f.replace(/url\(['"]?.*?['"]?\)/,`url('${c||""}')`);r.style.backgroundImage=m}else r.style.backgroundImage=`url('${c||""}')`}}else l==="image_position"||l==="imagePosition"?c==="left"?(r.classList.remove("image-right"),r.classList.add("image-left")):(r.classList.remove("image-left"),r.classList.add("image-right")):l==="style"&&r.classList.contains("reveal-section")?r.className=r.className.replace(/style-\w+/,`style-${c}`):/<[a-z][\s\S]*>/i.test(String(c))?r.innerHTML=String(c):r.textContent=String(c);if(o.includes("features.items")&&(l==="image"||l==="icon")){const f=r.closest(".feature-visual-wrapper");if(f){const m=f.querySelector(".feature-img-bind"),y=f.querySelector(".feature-icon-bind");if(m&&y){const $=m,C=$.src&&!$.src.includes("undefined")&&!$.src.endsWith("/");m.style.display=C?"":"none",y.style.display=C?"none":""}}}},d=o.match(/\[(\d+)\]/),u=d?parseInt(d[1]):void 0;n.forEach(r=>{const l=r,c=l.getAttribute("data-zflex-bind");c&&i(l,c,e[c],u)});const a=Array.from(t.querySelectorAll("[data-zflex-show]"));t.hasAttribute("data-zflex-show")&&a.push(t);const s=r=>{const l=r,c=l.getAttribute("data-zflex-show");if(!c)return;let p=e[c];if(c.includes(".")&&!c.includes("[")){const f=c.split("."),m=f[f.length-1];p=e[m]}const g=String(p)==="true"||p===!0;l.style.setProperty("display",g?"":"none","important")};if(a.forEach(r=>s(r)),o.includes("reveal")&&e.imagePosition){const r=t.querySelector(".reveal-grid");r&&i(r,"imagePosition",e.imagePosition)}}function B(t,e){const{id:o,items:n}=t,i=document.querySelector(`[data-zflex-repeater="${o}"]`);i?(console.log(`[Preview] RÃ©gÃ©nÃ©ration du repeater ${o}`),x(i,o,n),i.style.transition="opacity 0.2s",i.style.opacity="0.5",setTimeout(()=>i.style.opacity="1",200)):e?A(o,e):console.warn(`[Preview] Repeater container not found: ${o}`)}function H(){console.log("[Preview] Activating Interaction Hijacking (Anti-Navigation)"),document.addEventListener("click",t=>{const e=t.target.closest("a, button, input[type='submit']");if(!e)return;if(e.classList.contains("btn-primary")||e.id.includes("add-to-cart")||e.textContent?.toLowerCase().includes("commander")||e.closest("#cart-btn")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Action commerciale bloquÃ©e:",e);return}if(e.tagName==="A"){const n=e.getAttribute("href");if(n&&n!=="#"&&!n.startsWith("javascript:")){t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Navigation bloquÃ©e:",n);return}}console.log("âœ… [Preview] Interaction autorisÃ©e:",e)},!0),document.addEventListener("submit",t=>{t.preventDefault(),t.stopPropagation(),console.log("ðŸš« [Preview] Soumission de formulaire bloquÃ©e.")},!0)}function _(){window.__ZFLEX_PREVIEW_MODE__=!0,console.log("ðŸš« [Preview] Analytics neutralized via Global Flag.")}window.parent!==window&&window.parent.postMessage({source:"zflex-preview",action:"ready",payload:{url:window.location.href}},"*")}export{V as initPreviewMode};
